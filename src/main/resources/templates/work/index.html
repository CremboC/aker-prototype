<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head lang="en" th:include="fragments/common :: head"></head>
<body>

<div th:replace="fragments/common :: header">...</div>

<div class="container">

    <div class="page-header">
        <h2>
            Order Work
        </h2>
    </div>

    <div class="col-md-12">
        <div class="row">
            <div class="form-group">
                <label for="products" class="h3">
                    Choose product
                </label>
                <select name="product" id="products" class="form-control">
                    <option value=""></option>
                </select>
            </div>

            <h3>Groups</h3>

            <div th:replace="groups/table :: groupstable (${'append-groups'}, ${'load-groups'}, ${'metadata-groups'})"></div>


            <h3>Samples</h3>

            <div th:replace="samples/table :: samplestable (${'append-samples'}, ${'load-samples'}, ${'metadata-samples'})"></div>

        </div>

        <div class="row">

        </div>
    </div>

</div>

<script id="select-template" type="text/x-handlebars-template">
    <option value="{{ index }}">
        {{ name }}
    </option>
</script>


<div th:replace="fragments/common :: footer"></div>

<script type="application/javascript">
    $(document).ready(function () {
        var $samples = $('.jqp-samples'),
                $groups = $('.jqp-groups'),
                $template = $('#select-template'),
                $products = $('#products');

        // compile template using Handlebars
        var source = $template.html();
        var template = Handlebars.compile(source);

        var productQuery = $.ajax('http://localhost:8081/products/');

        productQuery.then(function (data) {
            var products = data._embedded.products;
            var sampleHtml = '';
            var samplesPager, groupsPager;

            $.each(products, function (index, product) {
                product.index = index;
                sampleHtml += template(product);
            });

            $products.append(sampleHtml);

            $products.on('change', function (e) {
                var valueSelected = this.value;

                if (valueSelected === '') {
                    return;
                }

                var validTypes = [];

                $.each(products[valueSelected].inputMaterial, function (index, material) {
                    validTypes.push(material.type.value);
                });


                var payload = {
                    data: {
                        types: validTypes.join(',')
                    }
                };

                samplesPager.load(payload);
                groupsPager.load(payload);

            });

            samplesPager = $samples.pager({
                url: '/samples/byType',
                template: '#sample-template',
                loadButton: '#load-samples',
                appendBefore: '#append-samples',
                metadata: '#metadata-samples',
                scrollLoad: true,
                preload: false
            });

            groupsPager = $groups.pager({
                url: '/groups/byType',
                template: '#group-template',
                loadButton: '#load-groups',
                appendBefore: '#append-groups',
                metadata: '#metadata-groups',
                scrollLoad: false,
                preload: false
            });

        }, function (xhr, status, errorThrown) {
            console.log(xhr);
            console.log(status);
            console.log(errorThrown);
        });

    })
    ;
</script>

</body>
</html>